<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAGAnything Local UI</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
        color: #222;
        background-color: #f9f9f9;
      }
      .section {
        margin-bottom: 24px;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      label {
        display: block;
        margin-top: 8px;
        font-weight: bold;
      }
      input[type="text"],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        margin-top: 12px;
        padding: 10px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #eee;
        padding: 12px;
        border-radius: 4px;
        min-height: 40px;
      }
      iframe.graph-frame {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ° RAGAnything æœ¬åœ°ç®¡ç†å°</h2>

    <div class="section">
      <h3>ğŸ”‘ API Key</h3>
      <label>å¯†é’¥ (x-api-key)</label>
      <input id="apiKey" type="text" placeholder="è¯·è¾“å…¥ RAGANYTHING_API_KEY" />
    </div>

    <div class="section">
      <h3>ğŸ“¥ å¯¼å…¥æ–‡æ¡£ (Ingest)</h3>
      <label>æ–‡æ¡£æ ‡è¯† (Doc ID - å¯é€‰)</label>
      <input id="docId" type="text" placeholder="è‡ªå®šä¹‰ doc_idï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ" />

      <label>é€‰æ‹©æ–‡ä»¶</label>
      <input id="fileInput" type="file" />

      <button onclick="ingestFile()">ç«‹å³å¯¼å…¥</button>
      <div id="ingestResult" style="margin-top: 10px; color: #555;"></div>
    </div>

    <div class="section">
      <h3>ğŸ” çŸ¥è¯†é—®ç­” (Query)</h3>
      <label>é€‰æ‹©å·²æœ‰å·¥ä½œç©ºé—´</label>
      <select id="workspaceSelect">
        <option value="">(è¯·åˆ·æ–°åˆ—è¡¨)</option>
      </select>
      <button onclick="refreshWorkspaces()">åˆ·æ–°å·¥ä½œç©ºé—´åˆ—è¡¨</button>

      <label>å½“å‰æ–‡æ¡£ ID</label>
      <input id="queryDocId" type="text" placeholder="å¾…æŸ¥è¯¢çš„ doc_id" />

      <label>æ‚¨çš„é—®é¢˜</label>
      <textarea id="question" rows="4" placeholder="è¯·æè¿°æ‚¨æƒ³ä»æ–‡æ¡£ä¸­äº†è§£çš„å†…å®¹..."></textarea>

      <button onclick="runQuery()">å¼€å§‹æé—®</button>
      <h4>âœ¨ å›ç­”:</h4>
      <pre id="answer">ç­‰å¾…å¤§ç‹å‚è¯¢...</pre>
    </div>

    <div class="section">
      <h3>ğŸ§  çŸ¥è¯†å›¾è°±å¯è§†åŒ–</h3>
      <label>é€‰æ‹©å·²æœ‰å·¥ä½œç©ºé—´</label>
      <select id="graphWorkspaceSelect">
        <option value="">(è¯·åˆ·æ–°åˆ—è¡¨)</option>
      </select>
      <button onclick="refreshWorkspaces()">åˆ·æ–°å·¥ä½œç©ºé—´åˆ—è¡¨</button>

      <label>å›¾è°± Doc ID</label>
      <input id="graphDocId" type="text" placeholder="å¾…å¯è§†åŒ–çš„ doc_id" />

      <label>GraphML è·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
      <input
        id="graphPath"
        type="text"
        placeholder="graph_chunk_entity_relation.graphml"
      />

      <button onclick="renderGraph()">æ‰“å¼€å¯è§†åŒ–</button>
      <div id="graphStatus" style="margin-top: 10px; color: #555;"></div>
      <iframe id="graphFrame" class="graph-frame"></iframe>
    </div>

    <script>
      // è·å–ç”¨æˆ·è¾“å…¥çš„ API Key
      function getApiKey() {
        return document.getElementById("apiKey").value || "";
      }

      // ä¸Šä¼ æ–‡æ¡£é€»è¾‘
      async function ingestFile() {
        const fileInput = document.getElementById("fileInput");
        const docId = document.getElementById("docId").value;
        const resultEl = document.getElementById("ingestResult");

        if (!fileInput.files.length) {
          resultEl.textContent = "æŠ¥å‘Šå¤§ç‹ï¼šè¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼";
          return;
        }

        const form = new FormData();
        form.append("file", fileInput.files[0]);
        if (docId) {
          form.append("doc_id", docId);
        }

        resultEl.textContent = "æ­£åœ¨è§£ææ–‡æ¡£ï¼Œè¯·ç¨å€™...";
        
        try {
          const resp = await fetch("/ingest", {
            method: "POST",
            headers: { "x-api-key": getApiKey() },
            body: form,
          });

          const data = await resp.json();
          resultEl.textContent = resp.ok
            ? `âœ… å¯¼å…¥æˆåŠŸï¼Doc ID: ${data.doc_id}`
            : `âŒ å¤±è´¥: ${data.detail || JSON.stringify(data)}`;
          
          if (resp.ok) {
            document.getElementById("queryDocId").value = data.doc_id;
            refreshWorkspaces(); // æˆåŠŸåé¡ºä¾¿åˆ·æ–°åˆ—è¡¨
          }
        } catch (e) {
          resultEl.textContent = "âŒ ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥ã€‚";
        }
      }

      // æŸ¥è¯¢é€»è¾‘
      async function runQuery() {
        const docId = document.getElementById("queryDocId").value;
        const question = document.getElementById("question").value;
        const answerEl = document.getElementById("answer");

        if (!docId || !question) {
          answerEl.textContent = "æŠ¥å‘Šå¤§ç‹ï¼šDoc ID å’Œé—®é¢˜éƒ½ä¸èƒ½ä¸ºç©ºï¼";
          return;
        }

        answerEl.textContent = "æ­£åœ¨æ€è€ƒä¸­... ğŸ¤”";

        try {
          const resp = await fetch("/query", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": getApiKey(),
            },
            body: JSON.stringify({
              doc_id: docId,
              query: question,
            }),
          });

          const data = await resp.json();
          answerEl.textContent = resp.ok
            ? data.answer
            : `âŒ é”™è¯¯: ${data.detail || JSON.stringify(data)}`;
        } catch (e) {
          answerEl.textContent = "âŒ è¿æ¥åç«¯å¤±è´¥ã€‚";
        }
      }

      // å›¾è°±å¯è§†åŒ–é€»è¾‘
      async function renderGraph() {
        const docId = document.getElementById("graphDocId").value;
        const graphPath = document.getElementById("graphPath").value;
        const frame = document.getElementById("graphFrame");
        const statusEl = document.getElementById("graphStatus");

        if (!docId) {
          statusEl.textContent = "æŠ¥å‘Šå¤§ç‹ï¼šDoc ID ä¸èƒ½ä¸ºç©ºï¼";
          return;
        }

        const params = new URLSearchParams({ doc_id: docId });
        if (graphPath) params.set("graph_path", graphPath);

        statusEl.textContent = "æ­£åœ¨ç”Ÿæˆå›¾è°±ï¼Œè¯·ç¨å€™...";
        frame.srcdoc = "";

        try {
          const resp = await fetch(`/graph?${params.toString()}`, {
            headers: { "x-api-key": getApiKey() },
          });
          const html = await resp.text();
          if (!resp.ok) {
            statusEl.textContent = `âŒ å¤±è´¥: ${html}`;
            return;
          }
          frame.srcdoc = html;
          statusEl.textContent = "âœ… å›¾è°±å·²åŠ è½½";
        } catch (e) {
          statusEl.textContent = "âŒ ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥ã€‚";
        }
      }

      // åˆ·æ–°åˆ—è¡¨é€»è¾‘
      async function refreshWorkspaces() {
        const select = document.getElementById("workspaceSelect");
        const graphSelect = document.getElementById("graphWorkspaceSelect");
        select.innerHTML = "<option value=''>åŠ è½½ä¸­...</option>";
        graphSelect.innerHTML = "<option value=''>åŠ è½½ä¸­...</option>";

        try {
          const resp = await fetch("/workspaces", {
            headers: { "x-api-key": getApiKey() },
          });
          const data = await resp.json();
          
          if (!resp.ok) {
            select.innerHTML = "<option value=''>æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥å¯†é’¥</option>";
            graphSelect.innerHTML = "<option value=''>æ— æ³•åŠ è½½ï¼Œè¯·æ£€æŸ¥å¯†é’¥</option>";
            return;
          }

          const options = data.workspaces || [];
          if (!options.length) {
            select.innerHTML = "<option value=''>æš‚æ— å·¥ä½œç©ºé—´</option>";
            graphSelect.innerHTML = "<option value=''>æš‚æ— å·¥ä½œç©ºé—´</option>";
            return;
          }

          select.innerHTML = "<option value=''>-- è¯·é€‰æ‹© --</option>";
          graphSelect.innerHTML = "<option value=''>-- è¯·é€‰æ‹© --</option>";
          options.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.doc_id;
            opt.textContent = `${item.doc_id} (æ›´æ–°äº: ${item.updated_at})`;
            select.appendChild(opt);
            graphSelect.appendChild(opt.cloneNode(true));
          });

          select.onchange = () => {
            if (select.value) document.getElementById("queryDocId").value = select.value;
          };
          graphSelect.onchange = () => {
            if (graphSelect.value) document.getElementById("graphDocId").value = graphSelect.value;
          };
        } catch (e) {
          select.innerHTML = "<option value=''>ç½‘ç»œè¿æ¥å¤±è´¥</option>";
          graphSelect.innerHTML = "<option value=''>ç½‘ç»œè¿æ¥å¤±è´¥</option>";
        }
      }

      // é¡µé¢åŠ è½½æ—¶å°è¯•è·å–åˆ—è¡¨
      refreshWorkspaces();
    </script>
  </body>
</html>